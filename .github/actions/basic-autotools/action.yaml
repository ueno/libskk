name: 'Basic build process of libskk using autotools'
description: 'Set up user and build directories, build, and run tests'

runs:
  using: composite
  steps:
    - name: Create user and directories
      run: $GITHUB_WORKSPACE/build/setup-wrapper.sh
      shell: bash

    - name: Build
      run: |
        cd $GITHUB_WORKSPACE
        # FIXME: Ideally this should be run by a different user than
        # "user" to catch any writing attempt to $(srcdir), which is
        # sometimes happens when autom4te creates cache files
        NOCONFIGURE=1 $GITHUB_WORKSPACE/build/run-wrapper.sh ./autogen.sh
        $GITHUB_WORKSPACE/build/run-wrapper.sh $GITHUB_WORKSPACE/configure --prefix=$GITHUB_WORKSPACE/$INSTALLDIR --libdir=$GITHUB_WORKSPACE/$INSTALLDIR/lib $BUILD_OPTS
        $GITHUB_WORKSPACE/build/run-wrapper.sh make -j$(nproc) V=1
      shell: bash

    - name: Test
      run: |
        $GITHUB_WORKSPACE/build/run-wrapper.sh make check -j$(nproc) V=1
        ret=$?
        if test $ret -ne 0; then
          cat $GITHUB_WORKSPACE/test-suite.log
          exit $ret
        fi
      shell: bash

    - name: Distcheck
      if: ${{ env.DISTCHECK != 0 }}
      run: |
        if [ "$RUNNER_OS" = "Linux" ]; then
          $GITHUB_WORKSPACE/build/run-wrapper.sh make distcheck -j$(nproc) V=1
        fi
      shell: bash

    - name: Install
      run: |
        make install
        make installcheck
      shell: bash
